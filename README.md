# Сервис для работы с ПВЗ

Сервис для управления пунктами выдачи заказов (ПВЗ) и обработки приёмки товаров.

## Описание

Сервис позволяет сотрудникам ПВЗ вносить информацию по заказам и управлять приёмкой товаров. Основные возможности:

- Авторизация пользователей (модератор/сотрудник ПВЗ)
- Управление ПВЗ (создание, просмотр)
- Управление приёмками товаров
- Управление товарами в рамках приёмок
- Получение отчётов по ПВЗ с фильтрацией по датам

## Технический стек

- Язык: Go
- База данных: PostgreSQL
- Билдер запросов: Squirrel
- Контейнеризация: Docker & Docker Compose
- Метрики: Prometheus
- gRPC для API
- OpenAPI для HTTP API

## Требования к производительности

- RPS: 1000
- Время ответа: < 100 мс
- Доступность: 99.99%
- Покрытие тестами: > 75% (достигнуто)

## API

### HTTP API (порт 8080)

#### Авторизация
- `POST /dummyLogin` - получение токена по роли
- `POST /register` - регистрация нового пользователя
- `POST /login` - авторизация по email и паролю

#### ПВЗ
- `POST /pvz` - создание нового ПВЗ (только для модераторов)
- `GET /pvz` - получение списка ПВЗ с фильтрацией по датам

#### Приёмки
- `POST /pvz/{id}/reception` - создание новой приёмки
- `POST /pvz/{id}/reception/close` - закрытие приёмки
- `POST /pvz/{id}/reception/product` - добавление товара
- `DELETE /pvz/{id}/reception/product` - удаление последнего товара

### gRPC API (порт 3000)
- `GetPVZList` - получение списка всех ПВЗ

### Метрики (порт 9000)
- `/metrics` - эндпоинт Prometheus

## Запуск

1. Клонируйте репозиторий:
```bash
git clone https://github.com/your-username/avito_pvz.git
cd avito_pvz
```

2. Запустите сервис с помощью Docker Compose:
```bash
docker-compose up -d
```

## Тестирование

### Unit-тесты
```bash
go test ./... -cover
```

### Интеграционные тесты
Реализован интеграционный тест, который проверяет полный рабочий процесс:
1. Создание нового ПВЗ
2. Добавление новой приёмки заказов
3. Добавление 50 товаров в рамках текущей приёмки
4. Закрытие приёмки заказов

Запуск интеграционных тестов:
```bash
go test ./tests/integration/...
```

## Метрики

Сервис собирает следующие метрики:

### Технические
- Количество HTTP запросов
- Время ответа на запросы

### Бизнесовые
- Количество созданных ПВЗ
- Количество созданных приёмок
- Количество добавленных товаров

## Принятые решения

1. **Структура проекта**
   - Использована чистая архитектура
   - Разделение на слои: delivery, usecase, repository
   - Отдельные пакеты для HTTP и gRPC API

2. **База данных**
   - Использован PostgreSQL
   - Билдер запросов Squirrel
   - Миграции для управления схемой БД

3. **Авторизация**
   - JWT токены
   - Роли: модератор и сотрудник ПВЗ
   - Middleware для проверки прав доступа

4. **Метрики и мониторинг**
   - Prometheus для сбора метрик
   - Логирование через zap
   - Health checks для контейнеров

## Вопросы и ответы

1. **Почему выбрана чистая архитектура?**
   - Позволяет легко тестировать компоненты
   - Упрощает поддержку и развитие
   - Чёткое разделение ответственности

2. **Как обрабатываются ошибки?**
   - Единый формат ответов об ошибках
   - Кастомные типы ошибок
   - Логирование ошибок с контекстом

3. **Как обеспечивается производительность?**
   - Оптимизированные SQL запросы с использованием индексов
   - Эффективное использование транзакций
   - Оптимизация работы с базой данных через билдер запросов Squirrel 